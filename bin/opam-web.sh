#!/bin/sh

set -uex

BASEURL=$1 && shift && [ $# -eq 0 ] || { echo "Usage: $0 BASEURL" && exit 2; }

# /persist may contain:
#         /opam-repository (bare git clone)
#         /platform-blog (bare git clone)
#         /legacy (subdirectories copied verbatim)
#         /repo-cache (as generated by 'opam admin', 'cache/' and 'archives/' subdirs)
#         /logs-cache (cache of parsed logs used by opam2web)

cd /persist
# clone/update opam repo
if [ -d opam-repository ]; then
  git -C opam-repository fetch https://github.com/ocaml/opam-repository +master:master
else
  git clone https://github.com/ocaml/opam-repository opam-repository --bare --single-branch --branch master
fi

# clone/update opam blog
if [ -d blog ]; then
  git -C blog fetch https://github.com/ocaml/platform-blog +master:master
else
  git clone https://github.com/ocaml/platform-blog blog --bare --single-branch --branch master
fi

cd /www
# clone/update opam-repo to /www
if [ -d .git ]; then
  git fetch /persist/opam-repository
  if ! git reset FETCH_HEAD --hard; then git clean -ffdx; git reset FETCH_HEAD --hard; fi
else
  git clone -s /persist/opam-repository .
fi
# Overwrite 'repo' file, and dispatch all non-standard versions
cat <<EOF >repo
opam-version: "2.0"
browse: "https://${BASEURL}/pkg/"
upstream: "https://github.com/ocaml/opam-repository/tree/master/"
redirect: [
  "https://${BASEURL}/1.1" { opam-version < "1.2" }
  "https://${BASEURL}/1.2.0" { opam-version < "1.2.2" }
  "https://${BASEURL}/1.2.2" { opam-version < "2.0~" }
]
EOF
mkdir -p /persist/repo-cache/archives
mkdir -p /persist/repo-cache/cache
mkdir -p archives
opam admin cache -n --link=archives /persist/repo-cache/cache
rsync -a /persist/repo-cache/cache .
echo 'archive-mirrors: "cache"' >> repo
if [ -d /persist/legacy ]; then rsync -a /persist/legacy .; fi
opam admin index --minimal-urls-txt

cp -r /usr/local/share/opam2web/content /tmp/
git clone -s /persist/blog /tmp/content/blog

rm -rf /www/ext
mkdir -p /www/ext
cp -r -L /usr/local/share/opam2web/css /www/ext
cp -r -L /usr/local/share/opam2web/img /www/ext
cp -r -L /usr/local/share/opam2web/js /www/ext

mkdir -p /persist/logs-cache ~/.cache
ln -sf /persist/logs-cache ~/.cache/opam2web2

if [ -r /logs/access.log ]; then
    STATS_ARG="--statistics=/logs/access.log"
else
    STATS_ARG=""
fi

opam2web \
  --content=/tmp/content \
  --blog=https://github.com/ocaml/platform-blog/blob/master \
  $STATS_ARG \
  --root=$BASEURL \
  --output=/www

# Add some redirects
ln -sf . /www/doc/2.0

